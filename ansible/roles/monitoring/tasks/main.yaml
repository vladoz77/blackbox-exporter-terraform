# tasks/main.yaml
- name: install {{ victoriametrics_container_name }}
  ansible.builtin.include_tasks: victoriametrics.yaml
  when: victoriametrics_enable | default(true) | bool

- name: Wait for VictoriaMetrics to be healthy
  ansible.builtin.uri:
    url: "http://localhost:{{ victoriametrics_port }}/health"
    method: GET
    status_code: 200
    timeout: 10
  register: vm_health
  until: vm_health.status == 200
  retries: 30
  delay: 10
  when: victoriametrics_enable | default(true) | bool

- name: install {{ alertmanager_container_name }}
  ansible.builtin.include_tasks: alertmanager.yaml
  when: alertmanager_enable | default(true) | bool

- name: Wait for Alertmanager to be healthy
  ansible.builtin.uri:
    url: "http://localhost:{{ alertmanager_port }}/-/healthy"
    method: GET
    status_code: 200
    timeout: 10
  register: am_health
  until: am_health.status == 200
  retries: 20
  delay: 10
  when: alertmanager_enable | default(true) | bool

- name: install {{ vmalert_container_name }}
  ansible.builtin.include_tasks: vmalert.yaml
  when: vmalert_enable | default(true) | bool

- name: install {{ grafana_container_name }}
  ansible.builtin.include_tasks: grafana.yaml
  when: grafana_enable | default(true) | bool

- name: Wait for Grafana to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ grafana_port }}/api/health"
    method: GET
    status_code: 200
    timeout: 10
  register: grafana_health
  until: grafana_health.status == 200
  retries: 40
  delay: 15
  when: grafana_enable | default(true) | bool