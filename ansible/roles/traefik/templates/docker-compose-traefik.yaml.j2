services:
  traefik:
      image: {{ traefik_image }}:{{ traefik_version }}
      container_name: {{ traefik_container_name }}
      restart: always
      command:
        - "--api.insecure=true"
        - "--providers.docker=true"
        - "--entrypoints.web.address=:80"
        - "--entryPoints.websecure.address=:443"
        - "--entryPoints.websecure.http.tls=true"
        - "--providers.docker.exposedbydefault=false"
        - "--providers.docker.network={{ docker_network_name }}"
        - "--entryPoints.web.http.redirections.entryPoint.to=websecure"
        
        # Staging or Production CA server
        {% if traefik_acme_staging -%}
        - "--certificatesresolvers.le.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory"
        - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme-staging.json"
        
        {% else -%}
        - "--certificatesresolvers.le.acme.caServer=https://acme-v02.api.letsencrypt.org/directory"
        - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme-prod.json"
        {% endif %}
        
        # Let's Encrypt configuration
        - "--certificatesresolvers.le.acme.email={{ acme_email}}"
        - "--certificatesresolvers.le.acme.httpchallenge.entrypoint=web"
      labels:
        # Enable selfâ€‘routing
        - "traefik.enable=true"
        # Dashboard router
        {% if traefik_enable_dashboard -%}
        - "traefik.http.routers.dashboard.rule=Host(`{{ traefik_dashboard_url }}`)"
        - "traefik.http.routers.dashboard.entrypoints=websecure"
        - "traefik.http.routers.dashboard.service=api@internal"
        - "traefik.http.routers.dashboard.tls.certresolver=le"
        {% endif -%}
        - "traefik.http.middlewares.dashboard-auth.basicauth.users={{ traefik_dashboard_user }}:{{ traefik_dashboard_password_hash }}"
        - "traefik.http.routers.dashboard.middlewares=dashboard-auth"
      ports:
        - "80:80"
        - "443:443"
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - "{{ traefik_letsencrypt_path }}:/letsencrypt"
      networks:
        - {{ docker_network_name }}


networks:
  {{ docker_network_name }}:
    external: true