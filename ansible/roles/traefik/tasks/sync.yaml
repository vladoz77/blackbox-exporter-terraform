---
- name: Determine ACME file and S3 key
  set_fact:
    acme_local_file: "{{ traefik_acme_file_staging if traefik_acme_staging else traefik_acme_file_prod }}"
    acme_s3_key: "{{ s3_key_staging if traefik_acme_staging else s3_key_prod }}"

- name: Ensure acme.json exists locally
  ansible.builtin.stat:
    path: "{{ acme_local_file }}"
  register: local_acme

- name: Fail if acme.json not found locally
  ansible.builtin.fail:
    msg: "acme.json not found at {{ traefik_docker_dir }}/letsencrypt/acme.json — nothing to sync!"
  when: not local_acme.stat.exists

- name: Fail if ACME file is empty
  ansible.builtin.fail:
    msg: "ACME file at {{ acme_local_file }} is empty — not syncing to S3!"
  when: local_acme.stat.size == 0

- name: Upload acme.json to S3 (always overwrite)
  amazon.aws.s3_object:
    bucket: "{{ s3_bucket_name }}"
    object: "{{ acme_s3_key }}"
    src: "{{ acme_local_file }}"
    mode: put
    access_key: "{{ aws_access_key }}"
    secret_key: "{{ aws_secret_key }}"
    endpoint_url: "{{ yandex_storage_endpoint }}"
    region: "{{ yandex_region }}"
    overwrite: always
    encrypt: false
    permission: []

- name: Success message
  ansible.builtin.debug:
    msg: "{{ acme_s3_key }} successfully synced to s3://{{ s3_bucket_name }}/{{ acme_s3_key }}"
